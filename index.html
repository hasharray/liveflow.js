---
layout: default
---

<header class="banner">
  <h1 class="banner-title">Liveflow</h1>
  <em class="banner-tagline">Live Editing for JavaScript Developers</em>
</header>

<main class="content grid">
  <section id="editor" class="window half-width">
    <header class="window-header">
      <span class="window-title">demo/index.html</span>
    </header>

    <section class="window-pane">
      <ul class="tab-group">
      </ul>
    </section>
  </section>

  <section id="browser" class="window half-width">
    <header class="window-header">
      <span class="window-title">index.html</span>
    </header>

    <section class="window-pane">
      <iframe id="frame" class="frame"></iframe>
    </section>
  </section>
</main>

<script id="tab" type="text/template">
  <li id="$id" class="tab">
    <header class="tab-header">
      <a class="tab-link" href="#$id">$id</a>
    </header>

    <span class="tab-pane">
      <label class="editor" data-filename="$id">
        <pre class="editor-output" data-language="$language"></pre>
        <textarea class="editor-input" data-language="$language"></textarea>
      </label>
    </span>

    <script>
      setTimeout(function(item) {
        var group = item.closest('.tab-group');
        var link = item.querySelector('.tab-link');

        link.onclick = function() {
          var active = group.querySelector('.active');
          if (active) {
            active.classList.remove('active');
          }

          var href = link.getAttribute('href');

          var item = group.querySelector('[id="' + href.slice(1) + '"]');
          item.classList.add('active');

          var window = item.closest('.window');
          var title = window.querySelector('.window-title');
          title.innerText = item.id;

          event.preventDefault();
        };

        var editor = item.querySelector('.editor');
        var input = item.querySelector('.editor-input');
        var output = item.querySelector('.editor-output');

        input.spellcheck = false;
        input.wrap = "off";

        var timeout = null;
        var ready = false;
        input.oninput = function() {
          var value = input.value;

          var lines = value.split('\n');
          var width = 0;

          for (var i = 0; i < lines.length; i++) {
            var line = lines[i];
            width = (width > line.length) ? width : line.length;
          }

          input.rows = lines.length + 1;
          input.cols = width + 1;

          var grammar = Prism.languages[
            input.getAttribute('data-language')
          ];

          output.innerHTML = Prism.highlight(value, grammar);

          if (ready) {
            if (timeout) {
              clearTimeout(timeout);
            }

            timeout = setTimeout(function() {
              var content = frame.contentDocument;
              if (/\.js/.test(item.id)) {
                var target = content.getElementById(item.id);
                if (target.text != input.value) {
                  var clone = target.cloneNode(true);
                  clone.text = input.value;

                  content.inject(target, clone);
                }
              } else if (/\.html/.test(item.id)) {
                var target = content.documentElement;
                if (target.outerHTML.replace(/\n/g, '') != input.value.replace(/\n/, '')) {
                  var clone = target.cloneNode(true);
                  clone.innerHTML = input.value;

                  content.inject(target, clone);
                }
              }
            }, 500);
          } else {
            ready = true;
          }
        };

        input.disabled = true;
        var xhr = new XMLHttpRequest();
        xhr.open('GET', ['demo', item.id].join('/'));
        xhr.onload = function() {
          input.value = xhr.responseText;
          input.disabled = false;

          var event = document.createEvent('Event');
          event.initEvent('input', true, true);
          input.dispatchEvent(event);
        };

        xhr.send(null);
      }, 0, document.getElementById('$id'));
    </script>
  </li>
</script>

<script type="text/javascript">
  frame.onload = function() {
    var group = editor.querySelector('.tab-group');
    group.innerHTML = '';

    var id = 'index.html';
    group.innerHTML += tab.text
      .replace(/\$id/g, id)
      .replace(/\$language/g, 'html');

    var scripts = frame.contentDocument.getElementsByTagName('script');
    for (var i = 0; i < scripts.length; i++) {
      var script = scripts[i];
      var type = script.getAttribute('type');
      if (type != 'script') {
        continue;
      }

      var id = script.getAttribute('src');
      if (/cdn|liveflow/.test(id)) {
        continue;
      }

      group.innerHTML += tab.text
        .replace(/\$id/g, id)
        .replace(/\$language/g, 'javascript');
    }

    var item = editor.querySelector('.tab:last-child');
    item.className += ' active';

    var title = editor.querySelector('.window-title');
    title.innerText = item.id;

    setTimeout(function(group) {
      var scripts = Array.from(
        group.getElementsByTagName('script')
      );

      for (var i = 0; i < scripts.length; i++) {
        var script = scripts[i];

        var parent = script.parentElement;
        var clone = document.createElement('script');
        clone.text = script.text;

        parent.replaceChild(clone, script);
      }
    }, 0, group);
  };

  frame.src = '//' + location.host + '/demo/index.html';
</script>
